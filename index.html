<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>éŸ³ç¬¦æ‰¾æ‰¾æ¨‚ï¼ˆçµ±ä¸€ç‰ˆï¼‹å¯ç¸®æ”¾ï¼‹æç¤ºæ¡†é–ƒçˆï¼‰</title>
<style>
:root{
  --bg:#ffffff; --panel:#f6f7fb; --border:#d1d5db; --text:#0b1020;
  --accent:#0ea5e9; --accent2:#10b981; --tile:#ffffff; --tile-border:#d1d5db;
  --gap:10px; --cell:84px; /* å›ºå®šè¨­è¨ˆå°ºå¯¸ï¼Œé€éæ•´é«”ç¸®æ”¾ä¾†é©é…å„è£ç½® */
}

/* åŸºæœ¬æ¨£å¼ */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
  -webkit-text-size-adjust:100%; text-size-adjust:100%;
}
img{max-width:100%;height:auto;-webkit-user-drag:none;user-select:none}
button{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
button:hover{background:#f8fafc} button:disabled{opacity:.6;cursor:not-allowed}

/* â€”â€” çµ±ä¸€ç‰ˆé¢ï¼šæ•´é«”ç¸®æ”¾å®¹å™¨ â€”â€” */
#app{
  width:1120px;              /* è¨­è¨ˆå¯¬åº¦å›ºå®š */
  position:absolute; left:0; top:0; transform-origin:top left;
}
.app-bg{position:fixed; inset:0; background:var(--bg);} /* è®“èƒŒæ™¯é‹ªæ»¿è¦–çª— */

/* Headerï¼ˆå–æ¶ˆ stickyï¼Œé¿å…ä¸åŒç€è¦½å™¨å·®ç•°ï¼‰ */
header{background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;z-index:5}
.hrow{display:grid;grid-template-columns:auto 1fr;gap:10px;margin:0 auto}
.game-title{margin:0;font-weight:900;line-height:1.05;letter-spacing:.02em}
.game-title span{display:inline;margin-right:.15em;font-size:56px}
.game-title span:last-child{margin-right:0}
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
.stat{border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#374151;background:#fff}

/* Mainï¼šå›ºå®šå…©æ¬„ï¼Œä¸åš RWD æ–·é»ï¼Œé æ•´é«”ç¸®æ”¾é©é… */
.wrap{margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr 340px;gap:14px}
.board,.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
.board{padding:16px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;min-height:560px}
.grid{display:grid;grid-template-columns:repeat(7,var(--cell));grid-auto-rows:var(--cell);gap:var(--gap)}
.cell{background:var(--tile);border:1px solid var(--tile-border);border-radius:14px;display:flex;align-items:center;justify-content:center;width:var(--cell);height:var(--cell);position:relative}
.cell img{width:90%;height:90%;object-fit:contain}
.cell.selected{outline:2px solid var(--accent)}
.cell.found{outline:2px solid var(--accent2);background:#ecfdf5}
.cell.wrong{outline:2px solid #ef4444;background:#fef2f2}

/* âœ… æ–°ï¼šæç¤ºä»¥ã€Œæ¡†æ¡†é–ƒçˆã€å‘ˆç¾ï¼ˆä¸å†ç•«ç·šï¼‰ */
.cell.hinted::after{
  content:"";
  position:absolute;
  inset:-4px;                 /* é‚Šæ¡†ç¨å¾®å¤–æ“´ï¼Œæ¸…æ¥šå¯è¦‹ */
  border:4px solid #f59e0b;   /* æ©˜è‰²æ¡† */
  border-radius:14px;
  box-shadow:
    0 0 10px rgba(245,158,11,.8),
    inset 0 0 6px rgba(245,158,11,.6);
  animation:hintBlink .9s ease-in-out infinite;
  pointer-events:none;
}
@keyframes hintBlink{
  0%   { opacity:.35; transform:scale(.99); }
  50%  { opacity:1;   transform:scale(1.01); }
  100% { opacity:.35; transform:scale(.99); }
}

.panel{padding:14px;display:flex;flex-direction:column;min-height:560px}
.mode{display:flex;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.mode input{display:none}
.mode label{border:1px solid var(--border);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800;background:#fff}
.mode input:checked+label{outline:2px solid var(--accent2);background:#ecfdf5}
.task{display:flex;flex-direction:column;gap:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;align-items:center;height:100%;overflow:auto}
.task img{height:120px;border:1px solid var(--border);border-radius:10px;background:#fff}
.subtle{color:#515a6a;font-size:13px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
.sep{flex:1}

/* è¦–çª—ï¼ˆabsoluteï¼Œèˆ‡ #app ä¸€èµ·ç¸®æ”¾ï¼‰ */
.modal, #overlay, #wino{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:80}
#overlay .card, #wino .card, .modal .box{
  background:#fff;border:1px solid var(--border);border-radius:16px;
  width:min(760px,92vw);max-height:92svh;padding:18px 16px;overflow:auto;
  box-shadow:0 24px 70px rgba(0,0,0,.35)
}
#wino .card{border-radius:18px;padding:24px 22px}
#wino h3{font-size:28px;margin:0 0 8px 0}
#wino .stats{display:flex;justify-content:center;gap:16px;margin:10px 0 18px;flex-wrap:wrap}
#wino .pill{padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:#f9fafb;font-weight:800}
#playerName{width:min(360px,80%);padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:16px;margin:8px auto 0;display:block}

#overlay .card{color:#111}
#overlay .actions{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
#overlay .primary{border-color:#f59e0b;background:#fff7ed}

.modal h2{margin:0 0 6px 0}.modal .lead{color:#4b5563;margin:0 0 10px 0}.modal .btns{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:12px}
.table{width:100%;border-collapse:collapse;margin-top:10px}
.table th,.table td{border:1px solid var(--border);padding:8px 10px;text-align:center}
.table th{background:#f8fafc}
.hidden{display:none !important}

/* footer */
footer{ text-align:center;font-size:12px;margin:16px 0 20px;color:#6b7280}
footer a{color:#6b7280}
</style>
</head>
<body>
<div class="app-bg"></div>
<div id="app" aria-label="çµ±ä¸€ç‰ˆå¯ç¸®æ”¾å®¹å™¨">
  <header>
    <div class="hrow">
      <h1 class="game-title"><span>éŸ³ç¬¦</span><span>æ‰¾æ‰¾æ¨‚</span></h1>
      <div class="controls">
        <button id="newGameBtn">æ–°å±€</button>
        <button id="shuffleBtn">é‡æ’ç›¤é¢</button>
        <button id="hintBtn">æç¤º Ã—<span id="hintsLeft">3</span></button>
        <button id="pauseBtn">æš«åœ</button>
        <button id="leaderBtn">æ’è¡Œæ¦œ</button>
        <div class="stat">åˆ†æ•¸ï¼š<b id="score">0</b>ï½œå®Œæˆï¼š<b id="done">0</b>/5ï½œè¨ˆæ™‚ï¼š<b id="clock">00:00:00</b></div>
        <div class="volume" title="èƒŒæ™¯éŸ³é‡">ğŸµ BGM
          <input id="volBgm" type="range" min="0" max="1" step="0.01" value="0.5">
          <button id="bgmToggle">æ’­æ”¾BGM</button>
        </div>
        <div class="volume" title="éŸ³æ•ˆéŸ³é‡ï¼ˆç­”å°/ç­”éŒ¯ï¼‰">ğŸ”Š éŸ³æ•ˆèª¿æ•´
          <input id="volSfx" type="range" min="0" max="1" step="0.01" value="0.7">
          <button id="testSfx">æ¸¬è©¦éŸ³æ•ˆ</button>
        </div>
      </div>
    </div>
  </header>

  <div class="wrap" id="gameWrap">
    <section class="board" id="boardSec">
      <!-- æ³¨æ„ï¼šå·²ç§»é™¤ <svg id="hintSvg">ï¼Œæç¤ºæ”¹ç‚ºæ¡†æ¡†é–ƒçˆ -->
      <div id="grid" class="grid" aria-label="7x7 grid"></div>
    </section>

    <aside class="panel" id="sidePanel">
      <div class="subtle">é–‹å§‹å‰ï¼Œå…ˆé¸æ“‡æ¨¡å¼ï¼š</div>
      <div class="mode" role="tablist">
        <input type="radio" id="mode-sol" name="mode" value="solfege" checked><label for="mode-sol">å”±å</label>
        <input type="radio" id="mode-pit" name="mode" value="pitch"><label for="mode-pit">éŸ³å</label>
      </div>
      <div class="subtle">è¦å‰‡ï¼šæŠ½å‡º <b>4</b> å¼µäº”ç·šè­œä»»å‹™å¡ï¼Œåœ¨ç›¤é¢ä¸­æ‰¾ã€Œ<b>ç›´ç·šã€æ–œç·šæˆ–æ©«ç·š</b>ã€é€£çºŒå››æ ¼ï¼Œä¸”é †åºä¸€è‡´ã€‚</div>
      <div style="margin-top:10px" class="subtle">æœ¬å›åˆä»»å‹™ï¼ˆäº”ç·šè­œï¼‰ï¼š</div>
      <div id="task" class="task"></div>
      <div class="row">
        <button id="rerollBtn">é‡æŠ½ä»»å‹™</button>
        <button id="clearSelBtn">æ¸…é™¤é¸å–</button>
        <span class="sep"></span>
      </div>
    </aside>
  </div>

  <!-- é–‹å±€è§£èªªï¼ˆæŒ‰ã€Œé–‹å§‹éŠæˆ²ã€ï¼ç›´æ¥é–‹æ–°å±€ï¼‰ -->
  <div id="introModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <h2>å¦‚ä½•éŠç©ï¼Ÿ</h2>
      <p class="lead">æŠ½å‡º 4 å¼µ<strong>äº”ç·šè­œä»»å‹™å¡</strong>ï¼Œåœ¨ 7Ã—7 ç›¤é¢æ‰¾å‡ºã€Œ<strong>ç›´ç·šã€æ©«ç·šæˆ–æ–œç·š</strong>ã€é€£çºŒå››æ ¼ä¸”<strong>é †åºä¸€è‡´</strong>ã€‚</p>
      <ul style="text-align:left;line-height:1.6">
        <li>é–‹å§‹å‰é¸æ“‡ï¼š<b>å”±å</b> æˆ– <b>éŸ³å</b>ï¼ˆç›¤é¢å¡ç‰Œä¾æ¨¡å¼é¡¯ç¤ºï¼‰</li>
        <li>å®Œæˆ 5 çµ„ä»»å‹™éé—œï¼›æ­£ç¢º +10 åˆ†</li>
        <li>30 ç§’ç„¡æ“ä½œæœƒè·³ä¸€æ¬¡æç¤ºï¼›æ‰‹å‹•æç¤ºæœ€å¤š 3 æ¬¡</li>
      </ul>
      <div class="btns">
        <label><input type="radio" name="introMode" value="solfege" checked> å”±å</label>
        <label><input type="radio" name="introMode" value="pitch"> éŸ³å</label>
      </div>
      <div class="btns">
        <button id="introStart" class="primary" style="border:1px solid #f59e0b;background:#fff7ed">é–‹å§‹éŠæˆ²</button>
      </div>
    </div>
  </div>

  <!-- æ’è¡Œæ¦œ -->
  <div id="leaderModal" class="modal" role="dialog" aria-modal="true">
    <div class="box">
      <h2>æ’è¡Œæ¦œ</h2>
      <p class="lead">ä¾åˆ†æ•¸ç”±é«˜åˆ°ä½ï¼›åŒåˆ†ä»¥ç”¨æ™‚è¼ƒçŸ­è€…å„ªå…ˆã€‚</p>
      <table class="table" id="leaderTable"><thead><tr><th>#</th><th>ç©å®¶</th><th>åˆ†æ•¸</th><th>ç”¨æ™‚</th><th>æ—¥æœŸ</th></tr></thead><tbody></tbody></table>
      <div class="btns">
        <button id="clearLeaderboard">æ¸…é™¤æ’è¡Œæ¦œ</button>
        <button id="leaderClose">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- 30 ç§’æœªæ“ä½œæç¤ºï¼ˆåªå‡ºç¾ä¸€æ¬¡ï¼‰ -->
  <div id="overlay" class="modal" role="dialog" aria-modal="true" style="display:none">
    <div class="box">
      <h3>éœ€è¦æç¤ºå—ï¼Ÿ</h3>
      <p>å·²ç¶“ 30 ç§’æ²’æœ‰å‹•ä½œäº†ï¼Œæˆ‘å¯ä»¥é«˜äº®é¡¯ç¤ºæ­£ç¢ºè·¯å¾‘çš„å››æ ¼ã€‚è‹¥é‚„éœ€è¦æ›´å¤šæç¤ºï¼Œè«‹ç”¨å³ä¸Šã€Œæç¤ºã€æŒ‰éµï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ã€‚</p>
      <div class="actions" style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="overlayShowHint" class="primary" style="border:1px solid #f59e0b;background:#fff7ed">é¡¯ç¤ºæç¤º</button>
        <button id="overlayLater">ç¨å¾Œå†èªª</button>
      </div>
    </div>
  </div>

  <!-- éé—œçµç®— -->
  <div id="wino" role="dialog" aria-modal="true" style="display:none">
    <div class="card">
      <h3>ğŸ‰ æ­å–œéé—œï¼</h3>
      <div class="stats">
        <div class="pill">â±ï¸ æ™‚é–“ï¼š<span id="finalTime">00:00:00</span></div>
        <div class="pill">ğŸ† åˆ†æ•¸ï¼š<span id="finalScore">0</span></div>
      </div>
      <div style="margin:8px 0 4px">è«‹è¼¸å…¥ä½ çš„åç¨±ä»¥åŠ å…¥æ’è¡Œæ¦œï¼š</div>
      <input id="playerName" maxlength="20" placeholder="ä¾‹å¦‚ï¼šå°éŸ³ç¬¦"/>
      <div class="actions" style="margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button id="saveScoreBtn" class="primary" style="border:1px solid #0ea5e9;background:#eef6ff">å„²å­˜æˆç¸¾</button>
        <button id="playAgain" class="primary" style="border:1px solid #10b981;background:#ecfdf5">å†ç©ä¸€æ¬¡</button>
        <button id="closeWin">é—œé–‰</button>
      </div>
    </div>
  </div>

  <!-- éŸ³æ•ˆï¼ˆä¿ç•™åŸè·¯å¾‘èˆ‡æª”åï¼‰ -->
  <audio id="bgm" src="audio/bgm.mp3" loop></audio>
  <audio id="sndCorrect" src="audio/correct.mp3"></audio>
  <audio id="sndWrong" src="audio/wrong.mp3"></audio>

  <footer>
    "Almost New" Kevin MacLeod (incompetech.com) Â· Licensed under CC BY 4.0
    <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener">http://creativecommons.org/licenses/by/4.0/</a>
  </footer>
</div>

<script>
/* ========== è³‡æ–™ï¼ˆå®Œæ•´ä¿ç•™ï¼‰ ========== */
const BASE_NAMES = [
  // éŠæˆ²2ï¼ˆ10ï¼‰
  "ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€é–“fa","ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šmi","ä½éŸ³è­œè™Ÿç¬¬ä¸€é–“la","ä½éŸ³è­œè™Ÿç¬¬ä¸€ç·šsol","ä½éŸ³è­œè™Ÿç¬¬äºŒç·šsi",
  "é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“sol","é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šla","é«˜éŸ³è­œè™Ÿç¬¬äº”ç·šfa","é«˜éŸ³è­œè™Ÿç¬¬å››é–“mi","é«˜éŸ³è­œè™Ÿç¬¬å››ç·šre",
  // æ–°å¢ï¼ˆ16ï¼‰
  "ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si","ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo","ä½éŸ³è­œè™Ÿç¬¬äºŒé–“do","ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi","ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre",
  "ä½éŸ³è­œè™Ÿç¬¬å››é–“sol","ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa","ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla","é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo","é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re",
  "é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi","é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa","é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol","é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la","é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi","é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“do"
];
const PATHS = { staff:"assets/äº”ç·šè­œ/", solfege:"assets/å”±å/", pitch:"assets/éŸ³å/" };
const MAX_HINTS = 3; const LB_KEY="note_hunt_leaderboard_v1";

/* DOM */
const $ = s=>document.querySelector(s);
const gridEl=$("#grid"), taskEl=$("#task"), scoreEl=$("#score"), doneEl=$("#done"), clockEl=$("#clock");
const overlay=$("#overlay"), overlayShowHint=$("#overlayShowHint"), overlayLater=$("#overlayLater");
const wino=$("#wino"), finalTimeEl=$("#finalTime"), finalScoreEl=$("#finalScore");
const leaderModal=$("#leaderModal"), leaderBody=(document.querySelector("#leaderTable")||{}).querySelector ? document.querySelector("#leaderTable").querySelector("tbody") : null;
const volBgm=$("#volBgm"), volSfx=$("#volSfx"), bgm=$("#bgm"), sndCorrect=$("#sndCorrect"), sndWrong=$("#sndWrong");

/* ç‹€æ…‹ */
const state={mode:"solfege",grid:[],task:[],selected:[],score:0,done:0,hints:MAX_HINTS,elapsed:0,timer:null,paused:false,lastAction:Date.now(),overlayTriggered:false,won:false,started:false};

/* å·¥å…· */
function inBounds(r,c){return r>=0&&r<7&&c>=0&&c<7;}
function formatHMS(s){const hh=String(Math.floor(s/3600)).padStart(2,"0"), mm=String(Math.floor((s%3600)/60)).padStart(2,"0"), ss=String(s%60).padStart(2,"0"); return `${hh}:${mm}:${ss}`;}
function extractSolfege(base){const xs=["do","re","mi","fa","sol","la","si"]; for(const x of xs){if(base.endsWith(x))return x;} for(const x of xs){if(base.includes(x))return x;} return null;}
const SOL2PITCH={do:"c",re:"d",mi:"e",fa:"f",sol:"g",la:"a",si:"b"};

/* ç‰©ä»¶ */
function buildObj(base,kind){const sol=extractSolfege(base), pit=SOL2PITCH[sol]; const suffix=kind==="staff"?"äº”ç·šè­œ":(kind==="solfege"?"å”±å":"éŸ³å"); return {base,noteSol:sol,notePitch:pit,kind,src:PATHS[kind]+base+suffix+".png"}}

/* ç”¢ç›¤ */
function makeGrid(){
  const kind=state.mode; const bases=[...BASE_NAMES]; const tmp=[]; while(tmp.length<49) tmp.push(...bases); tmp.length=49;
  for(let i=tmp.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [tmp[i],tmp[j]]=[tmp[j],tmp[i]];}
  state.grid=tmp.map(b=>buildObj(b,kind));
}

/* ç•«ç›¤ */
function drawGrid(){
  gridEl.innerHTML="";
  state.grid.forEach((obj,idx)=>{
    const d=document.createElement("div"); d.className="cell"; d.dataset.idx=idx;
    const img=document.createElement("img"); img.src=obj.src; img.alt=obj.base;
    d.appendChild(img);
    d.addEventListener("click",onCellClick,{passive:true});
    gridEl.appendChild(d);
  });
  resetSelection();
}

/* ç›´ç·šé›†åˆ */
const DIRS=[[0,1],[0,-1],[1,0],[-1,0],[1,1],[-1,-1],[1,-1],[-1,1]];
function scanSequences(){
  const res=[];
  for(let r=0;r<7;r++)for(let c=0;c<7;c++)for(const[dr,dc] of DIRS){
    const cells=[]; let ok=true;
    for(let k=0;k<4;k++){const nr=r+dr*k,nc=c+dc*k;if(!inBounds(nr,nc)){ok=false;break;} cells.push([nr,nc]);}
    if(ok) res.push(cells);
  }
  return res;
}

/* ä»»å‹™ï¼ˆä¿è­‰å¯è§£ï¼‰ */
function dealTask(){
  clearHintOverlay();
  const seqs=scanSequences(); const chosen=seqs[(Math.random()*seqs.length)|0];
  const want=chosen.map(([r,c])=>state.grid[r*7+c]);
  state.task=want.map(o=>buildObj(o.base,"staff"));
  taskEl.innerHTML=""; state.task.forEach(t=>{const img=document.createElement("img"); img.src=t.src; img.alt=t.base; taskEl.appendChild(img);});
  state.lastAction=Date.now();
}

/* é»æ ¼é‚è¼¯ */
function resetSelection(){ state.selected=[]; document.querySelectorAll(".cell").forEach(el=>el.classList.remove("selected","wrong","hinted")); }
function onCellClick(e){
  if(!state.started||state.paused) return;
  const idx=+e.currentTarget.dataset.idx; if(state.selected.includes(idx)) return;
  state.selected.push(idx); e.currentTarget.classList.add("selected"); state.lastAction=Date.now();
  if(state.selected.length===4) validateSelection();
}
function isStraight(sel){
  const pts=sel.map(i=>[Math.floor(i/7),i%7]); const [a,b,c,d]=pts, v=(p,q)=>[q[0]-p[0],q[1]-p[1]];
  const v1=v(a,b),v2=v(b,c),v3=v(c,d); const same=(x,y)=>x[0]==y[0]&&x[1]==y[1];
  const valid=([dr,dc])=>[-1,0,1].includes(dr)&&[-1,0,1].includes(dc)&&(dr!==0||dc!==0);
  return valid(v1)&&same(v1,v2)&&same(v2,v3);
}
function validateSelection(){
  const sel=state.selected, straight=isStraight(sel);
  const cells=sel.map(i=>state.grid[i]); const want=state.task;
  const values=cells.map(o=>state.mode==="solfege"?o.noteSol:o.notePitch);
  const target=want.map(o=>state.mode==="solfege"?o.noteSol:o.notePitch);
  const match=straight && values.every((v,i)=>v===target[i]);
  if(match){
    mark(sel,"found"); state.score+=10; state.done+=1; scoreEl.textContent=state.score; doneEl.textContent=state.done;
    try{sndCorrect.currentTime=0;sndCorrect.play();}catch{}
    resetSelection(); if(state.done>=5){ endGame(); } else { dealTask(); }
  }else{
    mark(sel,"wrong"); try{sndWrong.currentTime=0;sndWrong.play();}catch{}
    setTimeout(()=>{ mark(sel,null,true); resetSelection(); },600);
  }
}
function mark(idxs,cls,clearOnly=false){
  idxs.forEach(i=>{const el=gridEl.children[i]; el.classList.remove("selected","found","wrong","hinted"); if(!clearOnly&&cls) el.classList.add(cls);});
}

/* å¼·åŠ›æç¤ºï¼ˆæ”¹ç‚ºåªåŠ ã€Œhintedã€æ¡†æ¡†ï¼Œä¸ç•«ç·šï¼‰ */
function findCurrentTargetSeq(){
  const target=state.task.map(o=>state.mode==="solfege"?o.noteSol:o.notePitch).join(",");
  const seqs=scanSequences();
  for(const s of seqs){
    const vals=s.map(([r,c])=>state.grid[r*7+c]).map(o=>state.mode==="solfege"?o.noteSol:o.notePitch).join(",");
    if(vals===target) return s;
  } return null;
}
function clearHintOverlay(){
  document.querySelectorAll(".cell.hinted").forEach(el=>el.classList.remove("hinted"));
}
function useHint(){
  if(state.hints<=0){alert("æç¤ºæ¬¡æ•¸å·²ç”¨å®Œ");return;}
  const seq=findCurrentTargetSeq(); if(!seq){dealTask();return;}
  const idxs=seq.map(([r,c])=>r*7+c);
  idxs.forEach(i=>gridEl.children[i].classList.add("hinted"));  // âœ… å››æ ¼é–ƒçˆæ¡†æ¡†
  state.hints--;
  document.querySelector("#hintsLeft").textContent=state.hints;
  state.lastAction=Date.now();
  if(state.hints<=0) $("#hintBtn").disabled=true;
}

/* ä¸€æ¬¡æ€§æç¤º Overlay */
function openOverlay(){ overlay.style.display="flex"; }
function closeOverlay(){ overlay.style.display="none"; }

/* è¨ˆæ™‚ */
function startTimer(){
  clearInterval(state.timer); clockEl.textContent="00:00:00"; state.elapsed=0;
  state.timer=setInterval(()=>{
    if(state.paused||state.won||!state.started) return;
    state.elapsed++; clockEl.textContent=formatHMS(state.elapsed);
    if(Date.now()-state.lastAction>=30000 && !state.overlayTriggered){ openOverlay(); state.overlayTriggered=true; }
  },1000);
}

/* çµæŸ */
function endGame(){
  clearInterval(state.timer); state.won=true; state.started=false;
  finalTimeEl.textContent=formatHMS(state.elapsed); finalScoreEl.textContent=state.score; wino.style.display="flex";
}

/* æ’è¡Œæ¦œ */
function loadLB(){ try{return JSON.parse(localStorage.getItem(LB_KEY)||"[]");}catch(e){return[];} }
function saveLB(arr){ try{localStorage.setItem(LB_KEY,JSON.stringify(arr));}catch(e){} }
function addScore(entry){ const arr=loadLB(); arr.push(entry); arr.sort((a,b)=>b.score-a.score || a.timeSeconds-b.timeSeconds); if(arr.length>50) arr.length=50; saveLB(arr); }
function renderLB(){
  const arr=loadLB(); if(!leaderBody) return;
  leaderBody.innerHTML=arr.length?"":'<tr><td colspan="5">å°šç„¡ç´€éŒ„</td></tr>';
  arr.slice(0,20).forEach((e,i)=>{const tr=document.createElement("tr"); tr.innerHTML=`<td>${i+1}</td><td>${escapeHtml(e.name)}</td><td>${e.score}</td><td>${formatHMS(e.timeSeconds)}</td><td>${new Date(e.dateISO).toLocaleDateString()}</td>`; leaderBody.appendChild(tr);});
}
function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}

/* â€”â€” çµ±ä¸€ç‰ˆé¢ï¼šæ•´é«”ç¸®æ”¾é‚è¼¯ â€”â€” */
function applyUnifiedScale(){
  const app = document.getElementById('app');
  // å…ˆæ¸…é™¤ transform ä»¥å–å¾—å…§å®¹å¯¦éš›é«˜åº¦
  app.style.transform = 'none';
  app.style.left = '0px';
  app.style.top  = '0px';

  const designW = 1120;
  const appRect = app.getBoundingClientRect();
  const appH = appRect.height; // å…§å®¹å¯¦é«˜

  const vw = window.innerWidth || document.documentElement.clientWidth;
  const vh = window.innerHeight || document.documentElement.clientHeight;

  const scale = Math.min(vw / designW, vh / appH);
  app.style.transform = `scale(${scale})`;
  // ç½®ä¸­
  const left = (vw - designW * scale) / 2;
  const top  = (vh - appH   * scale) / 2;
  app.style.left = left + 'px';
  app.style.top  = top  + 'px';
}

/* é–‹æ–°å±€ */
function startNewGame(){
  // æ¨¡å¼
  const m=document.querySelector('input[name="introMode"]:checked')?.value;
  state.mode = m || (document.querySelector("#mode-sol")?.checked ? "solfege" : "pitch") || "solfege";
  if(state.mode==="solfege") $("#mode-sol").checked=true; else $("#mode-pit").checked=true;

  // é‡ç½®
  state.started=true; state.paused=false; state.score=0; state.done=0; state.hints=MAX_HINTS; state.elapsed=0; state.selected=[]; state.overlayTriggered=false; state.won=false;
  scoreEl.textContent="0"; doneEl.textContent="0"; document.querySelector("#hintsLeft").textContent=MAX_HINTS; clockEl.textContent="00:00:00";

  makeGrid(); drawGrid(); dealTask(); applyUnifiedScale(); startTimer();
}

/* éŸ³é‡/éŸ³æ•ˆ */
function applyVolumes(){ bgm.volume=parseFloat(volBgm.value); sndCorrect.volume=sndWrong.volume=parseFloat(volSfx.value); }
applyVolumes(); volBgm.addEventListener("input",applyVolumes); volSfx.addEventListener("input",applyVolumes);
$("#bgmToggle").addEventListener("click",async()=>{ if(bgm.paused){ try{await bgm.play(); $("#bgmToggle").textContent="æš«åœBGM";}catch{} } else { bgm.pause(); $("#bgmToggle").textContent="æ’­æ”¾BGM"; }});
$("#testSfx").addEventListener("click",()=>{ try{sndCorrect.currentTime=0; sndCorrect.play();}catch{} });

/* äº‹ä»¶ */
$("#hintBtn").addEventListener("click",()=>{ if(!state.started) return; useHint(); });
$("#clearSelBtn").addEventListener("click",resetSelection);
$("#rerollBtn").addEventListener("click",()=>{ if(!state.started) return; dealTask(); });
$("#shuffleBtn").addEventListener("click",()=>{ if(!state.started) return; makeGrid(); drawGrid(); dealTask(); applyUnifiedScale(); });
$("#pauseBtn").addEventListener("click",()=>{ state.paused=!state.paused; $("#pauseBtn").textContent=state.paused?"ç¹¼çºŒ":"æš«åœ"; if(!state.paused) state.lastAction=Date.now(); });
$("#leaderBtn").addEventListener("click",()=>{ renderLB(); leaderModal.style.display="flex"; });
$("#leaderClose").addEventListener("click",()=> leaderModal.style.display="none");
$("#clearLeaderboard").addEventListener("click",()=>{ if(confirm("ç¢ºå®šæ¸…é™¤æ’è¡Œæ¦œï¼Ÿ")){localStorage.removeItem(LB_KEY); renderLB();} });

// æ–°å±€æŒ‰éˆ•ï¼šä»å…ˆçœ‹åˆ°è§£èªªï¼›æŒ‰ã€Œé–‹å§‹éŠæˆ²ã€ç›´æ¥é–‹å±€
$("#newGameBtn").addEventListener("click",()=>{ document.querySelector("#introModal").style.display="flex"; });

// 30 ç§’æç¤º Overlay
overlayShowHint?.addEventListener("click",()=>{ closeOverlay(); useHint(); });
overlayLater?.addEventListener("click",closeOverlay);

// éé—œè¦–çª—
$("#saveScoreBtn").addEventListener("click",()=>{ const name=($("#playerName").value||"ç©å®¶").slice(0,20); addScore({name,score:state.score,timeSeconds:state.elapsed,dateISO:new Date().toISOString()}); renderLB(); alert("å·²å„²å­˜åˆ°æ’è¡Œæ¦œï¼"); });
$("#playAgain").addEventListener("click",()=>{ wino.style.display="none"; document.querySelector("#introModal").style.display="flex"; });
$("#closeWin").addEventListener("click",()=>{ wino.style.display="none"; });

/* åˆå§‹åŒ– */
document.addEventListener("DOMContentLoaded",()=>{
  document.querySelector("#introModal").style.display="flex";
  $("#introStart").addEventListener("click",()=>{ document.querySelector("#introModal").style.display="none"; startNewGame(); });
  // åˆå§‹ä¹Ÿåšä¸€æ¬¡ç¸®æ”¾ï¼ˆæœªé–‹å±€æ™‚ä¹Ÿèƒ½çœ‹è¦‹ä¸€è‡´ç‰ˆé¢ï¼‰
  applyUnifiedScale();
  window.addEventListener("resize",applyUnifiedScale,{passive:true});
});
</script>
</body>
</html>
