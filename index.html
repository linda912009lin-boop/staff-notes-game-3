<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>éŸ³ç¬¦æ‰¾æ‰¾æ¨‚</title>
<style>
:root{
  --bg:#ffffff;
  --panel:#f6f7fb;
  --border:#d1d5db;
  --text:#0b1020;
  --accent:#0ea5e9;
  --accent2:#10b981;
  --tile:#ffffff;
  --tile-border:#d1d5db;
  --gap:10px;
  --cell:84px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial}

/* ---------- Header ---------- */
header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:10px 14px;z-index:5}
.hrow{display:grid;grid-template-columns:1fr;gap:10px;max-width:1120px;margin:0 auto}
@media (min-width:980px){ .hrow{grid-template-columns:auto 1fr} }
.game-title{margin:0; font-weight:900; line-height:1.05; letter-spacing:.02em; text-wrap:balance; text-align:left;}
.game-title span{display:block; font-size:42px}
@media (min-width:720px){ .game-title span{display:inline; margin-right:.15em} .game-title span:last-child{margin-right:0} }
@media (min-width:980px){ .game-title span{font-size:56px} }
.controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center; justify-content:flex-start}
@media (min-width:980px){ .controls{justify-content:flex-end} }
button{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
button:hover{background:#f8fafc}
button:disabled{opacity:.6;cursor:not-allowed}
.stat{border:1px solid var(--border);padding:8px 12px;border-radius:10px;color:#374151;background:#fff}

/* ---------- Main ---------- */
.wrap{max-width:1120px;margin:14px auto;padding:0 14px;display:grid;grid-template-columns:1fr;gap:14px;min-height:calc(100% - 120px)}
@media (min-width:980px){.wrap{grid-template-columns:1fr 320px;min-height:calc(100% - 116px)}}
.board,.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.05)}
.board{padding:16px; display:flex; align-items:center; justify-content:center; position:relative; overflow:hidden}
#hintSvg{position:absolute; inset:16px; width:calc(100% - 32px); height:calc(100% - 32px); pointer-events:none}
.grid{display:grid;grid-template-columns:repeat(7,var(--cell));grid-auto-rows:var(--cell);gap:var(--gap)}
.cell{background:var(--tile);border:1px solid var(--tile-border);border-radius:14px;display:flex;align-items:center;justify-content:center;width:var(--cell);height:var(--cell)}
.cell img{width:90%;height:90%;object-fit:contain}
.cell.selected{outline:2px solid var(--accent)}
.cell.found{outline:2px solid var(--accent2);background:#ecfdf5}
.cell.wrong{outline:2px solid #ef4444;background:#fef2f2}
.cell.hinted{box-shadow:0 0 0 3px #f59e0b inset, 0 0 12px 6px rgba(245,158,11,.5); animation:pulse 1.2s ease-in-out infinite}
@keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.02)}100%{transform:scale(1)}}

.panel{padding:14px; display:flex; flex-direction:column; min-height:320px}
.mode{display:flex;gap:8px;margin-bottom:6px;flex-wrap:wrap}
.mode input{display:none}
.mode label{border:1px solid var(--border);padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:800;background:#fff}
.mode input:checked+label{outline:2px solid var(--accent2);background:#ecfdf5}
.task{display:flex;flex-direction:column;gap:12px;border:1px dashed var(--border);border-radius:12px;background:#fff;padding:10px;align-items:center; height:100%; overflow:auto}
.task img{height:120px;border:1px solid var(--border);border-radius:10px;background:#fff}
.subtle{color:#515a6a;font-size:13px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:10px}
.sep{flex:1}

/* éŸ³é‡æ§åˆ¶ */
.volume{display:flex; align-items:center; gap:8px; border:1px solid var(--border);padding:6px 10px; border-radius:10px; background:#fff; color:#374151}
.volume input[type="range"]{ width:140px }

/* 30ç§’æœªæ“ä½œæç¤º */
#overlay{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:60 }
#overlay .card{ background:#fff; color:#111; border-radius:16px; padding:20px; width:min(520px, 92vw); box-shadow:0 20px 60px rgba(0,0,0,.3); text-align:center}
#overlay .actions{ display:flex; gap:10px; justify-content:center; flex-wrap:wrap }
#overlay .primary{ border-color:#f59e0b; background:#fff7ed }

/* éé—œè¦–çª— */
#winOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:70 }
#winOverlay .card{ background:#ffffff; border-radius:18px; padding:24px 22px; width:min(560px, 92vw); text-align:center; box-shadow:0 24px 70px rgba(0,0,0,.35) }
#winOverlay h3{ font-size:28px; margin:0 0 8px 0 }
#winOverlay .stats{ display:flex; justify-content:center; gap:16px; margin:10px 0 18px; flex-wrap:wrap }
#winOverlay .statpill{ padding:10px 14px; border:1px solid var(--border); border-radius:12px; background:#f9fafb; font-weight:800 }
.hidden{ display:none !important }
</style>
</head>
<body>
<header>
  <div class="hrow">
    <h1 class="game-title"><span>éŸ³ç¬¦</span><span>æ‰¾æ‰¾æ¨‚</span></h1>
    <div class="controls">
      <button id="newGameBtn">æ–°å±€</button>
      <button id="shuffleBtn">é‡æ’ç›¤é¢</button>
      <button id="hintBtn">æç¤º Ã—<span id="hintsLeft">3</span></button>
      <button id="pauseBtn">æš«åœ</button>
      <div class="stat">åˆ†æ•¸ï¼š<b id="score">0</b>ï½œå®Œæˆï¼š<b id="done">0</b>/5ï½œè¨ˆæ™‚ï¼š<b id="clock">00:00:00</b></div>
      <div class="volume" title="èƒŒæ™¯éŸ³é‡">
        ğŸµ BGM éŸ³é‡
        <input id="volBgm" type="range" min="0" max="1" step="0.01" value="0.5">
        <button id="bgmToggle">æ’­æ”¾BGM</button>
      </div>
      <div class="volume" title="éŸ³æ•ˆéŸ³é‡ï¼ˆç­”å°/ç­”éŒ¯ï¼‰">
        ğŸ”Š éŸ³æ•ˆèª¿æ•´
        <input id="volSfx" type="range" min="0" max="1" step="0.01" value="0.7">
        <button id="testSfx">æ¸¬è©¦éŸ³æ•ˆ</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap" id="gameWrap">
  <section class="board" id="boardSec">
    <svg id="hintSvg"></svg>
    <div id="grid" class="grid" aria-label="7x7 grid"></div>
  </section>

  <aside class="panel" id="sidePanel">
    <div class="subtle">é–‹å§‹å‰ï¼Œå…ˆé¸æ“‡æ¨¡å¼ï¼š</div>
    <div class="mode" role="tablist">
      <input type="radio" id="mode-sol" name="mode" value="solfege" checked><label for="mode-sol">å”±å</label>
      <input type="radio" id="mode-pit" name="mode" value="pitch"><label for="mode-pit">éŸ³å</label>
    </div>
    <div class="subtle">è¦å‰‡ï¼šæŠ½å‡º <b>4</b> å¼µäº”ç·šè­œä»»å‹™å¡ï¼Œåœ¨ç›¤é¢ä¸­æ‰¾ã€Œ<b>ç›´ç·šã€æ–œç·šæˆ–æ©«ç·š</b>ã€é€£çºŒå››æ ¼ï¼Œä¸”é †åºä¸€è‡´ã€‚</div>
    <div style="margin-top:10px" class="subtle">æœ¬å›åˆä»»å‹™ï¼ˆäº”ç·šè­œï¼‰ï¼š</div>
    <div id="task" class="task"></div>

    <div class="row">
      <button id="rerollBtn">é‡æŠ½ä»»å‹™</button>
      <button id="clearSelBtn">æ¸…é™¤é¸å–</button>
      <span class="sep"></span>
    </div>
  </aside>
</div>

<!-- 30ç§’æœªæ“ä½œæç¤º -->
<div id="overlay" role="dialog" aria-modal="true">
  <div class="card">
    <h3>éœ€è¦æç¤ºå—ï¼Ÿ</h3>
    <p>å·²ç¶“ 30 ç§’æ²’æœ‰å‹•ä½œäº†ï¼Œæˆ‘å¯ä»¥å¹«ä½ é«˜äº®é¡¯ç¤ºæ­£ç¢ºè·¯å¾‘ã€‚è‹¥é‚„éœ€è¦æç¤ºï¼Œè«‹ä½¿ç”¨å³ä¸Šçš„ã€Œæç¤ºã€æŒ‰éµï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ã€‚</p>
    <div class="actions">
      <button id="overlayShowHint" class="primary">é¡¯ç¤ºæç¤º</button>
      <button id="overlayLater">ç¨å¾Œå†èªª</button>
    </div>
  </div>
</div>

<!-- éé—œçµç®— -->
<div id="winOverlay" role="dialog" aria-modal="true">
  <div class="card">
    <h3>ğŸ‰ æ­å–œéé—œï¼</h3>
    <div class="stats">
      <div class="statpill">â±ï¸ æ™‚é–“ï¼š<span id="finalTime">00:00:00</span></div>
      <div class="statpill">ğŸ† åˆ†æ•¸ï¼š<span id="finalScore">0</span></div>
    </div>
    <div class="actions">
      <button id="playAgain" class="primary">å†ç©ä¸€æ¬¡</button>
      <button id="closeWin">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- éŸ³æ•ˆ -->
<audio id="bgm" src="audio/bgm.mp3" loop></audio>
<audio id="sndCorrect" src="audio/correct.mp3"></audio>
<audio id="sndWrong" src="audio/wrong.mp3"></audio>

<script>
/* ========== 78 å¼µå¡ç‰Œ â€” ä»¥ 26 çµ„ã€ŒåŸºåº•åç¨±ã€æ´¾ç”Ÿï¼šäº”ç·šè­œ/å”±å/éŸ³å ========== */
const BASE_NAMES = [
  // éŠæˆ²2ï¼ˆ10ï¼‰
  "ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€é–“fa","ä½éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šmi","ä½éŸ³è­œè™Ÿç¬¬ä¸€é–“la","ä½éŸ³è­œè™Ÿç¬¬ä¸€ç·šsol","ä½éŸ³è­œè™Ÿç¬¬äºŒç·šsi",
  "é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“sol","é«˜éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šla","é«˜éŸ³è­œè™Ÿç¬¬äº”ç·šfa","é«˜éŸ³è­œè™Ÿç¬¬å››é–“mi","é«˜éŸ³è­œè™Ÿç¬¬å››ç·šre",
  // æ–°å¢ï¼ˆ16ï¼‰ â†’ å…± 26 çµ„
  "ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€é–“si","ä½éŸ³è­œè™Ÿä¸ŠåŠ ä¸€ç·šdo","ä½éŸ³è­œè™Ÿç¬¬äºŒé–“do","ä½éŸ³è­œè™Ÿç¬¬ä¸‰é–“mi","ä½éŸ³è­œè™Ÿç¬¬ä¸‰ç·šre",
  "ä½éŸ³è­œè™Ÿç¬¬å››é–“sol","ä½éŸ³è­œè™Ÿç¬¬å››ç·šfa","ä½éŸ³è­œè™Ÿç¬¬äº”ç·šla","é«˜éŸ³è­œè™Ÿä¸‹åŠ ä¸€ç·šdo","é«˜éŸ³è­œè™Ÿä¸‹ä¸€é–“re",
  "é«˜éŸ³è­œè™Ÿç¬¬ä¸€ç·šmi","é«˜éŸ³è­œè™Ÿç¬¬ä¸€é–“fa","é«˜éŸ³è­œè™Ÿç¬¬äºŒç·šsol","é«˜éŸ³è­œè™Ÿç¬¬äºŒé–“la","é«˜éŸ³è­œè™Ÿç¬¬ä¸‰ç·šsi","é«˜éŸ³è­œè™Ÿç¬¬ä¸‰é–“do"
];
const PATHS = { staff: "assets/äº”ç·šè­œ/", solfege: "assets/å”±å/", pitch: "assets/éŸ³å/" };
const MAX_HINTS = 3;

/* å·¥å…· */
const $ = s=>document.querySelector(s);
function inBounds(r,c){ return r>=0&&r<7&&c>=0&&c<7; }
const DIRS=[[0,1],[0,-1],[1,0],[-1,0],[1,1],[-1,-1],[1,-1],[-1,1]];
function formatHMS(s){ const hh=String(Math.floor(s/3600)).padStart(2,"0"); const mm=String(Math.floor((s%3600)/60)).padStart(2,"0"); const ss=String(s%60).padStart(2,"0"); return `${hh}:${mm}:${ss}`; }
function extractSolfege(base){
  const xs=["do","re","mi","fa","sol","la","si"];
  for(const x of xs){ if(base.endsWith(x)) return x; }
  for(const x of xs){ if(base.includes(x)) return x; }
  return null;
}
const SOL2PITCH={do:"c",re:"d",mi:"e",fa:"f",sol:"g",la:"a",si:"b"};

/* ç‹€æ…‹ */
const state = {
  mode:"solfege",      // solfege | pitch
  grid:[],             // 49 å€‹: {base, noteSol, notePitch, kind, src}
  task:[],             // 4 å¼µäº”ç·šè­œå¡
  selected:[],
  score:0, done:0, hints:MAX_HINTS,
  elapsed:0, timer:null, paused:false,
  lastAction: Date.now(), overlayTriggered:false,
  won:false
};

/* DOM refs */
const gridEl = $("#grid"), taskEl=$("#task"), scoreEl=$("#score"), doneEl=$("#done"), clockEl=$("#clock");
const overlay = $("#overlay"), overlayShowHint=$("#overlayShowHint"), overlayLater=$("#overlayLater");
const hintSvg = $("#hintSvg");
const winOverlay = $("#winOverlay"), finalTimeEl=$("#finalTime"), finalScoreEl=$("#finalScore");
const wrapEl = $("#gameWrap");

/* éŸ³æ•ˆ */
const bgm = $("#bgm"), sndCorrect=$("#sndCorrect"), sndWrong=$("#sndWrong");
const volBgm=$("#volBgm"), volSfx=$("#volSfx"), bgmToggle=$("#bgmToggle"), testSfx=$("#testSfx");
function applyVolumes(){ bgm.volume=parseFloat(volBgm.value); sndCorrect.volume=sndWrong.volume=parseFloat(volSfx.value); }
volBgm.addEventListener("input",applyVolumes); volSfx.addEventListener("input",applyVolumes); applyVolumes();
bgmToggle.addEventListener("click",async ()=>{ if(bgm.paused){ try{ await bgm.play(); bgmToggle.textContent="æš«åœBGM"; }catch{} } else{ bgm.pause(); bgmToggle.textContent="æ’­æ”¾BGM"; } });
testSfx.addEventListener("click",()=>{ try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch{} });

/* ç›¤é¢è‡ªé©æ‡‰ï¼šé¿å…æ²å‹•æ¢ */
function fitGridToViewport(){
  const header = document.querySelector('header');
  const wrap = document.querySelector('.wrap');
  const availableH = window.innerHeight - header.offsetHeight - 28;
  wrap.style.minHeight = availableH + 'px';
  const board = document.querySelector('.board');
  const boardInnerH = board.clientHeight - 32;
  const byHeight = Math.floor((boardInnerH - 10*6)/7);
  const byWidth  = Math.floor(((gridEl.clientWidth||board.clientWidth) - 10*6)/7);
  const cell = Math.max(56, Math.min(120, Math.min(byHeight, byWidth)));
  document.documentElement.style.setProperty('--cell', cell+'px');
}

/* ç‰©ä»¶å»ºæ§‹ */
function buildObj(base, kind){
  const sol = extractSolfege(base);
  const pit = SOL2PITCH[sol];
  const suffix = kind==="staff"?"äº”ç·šè­œ":(kind==="solfege"?"å”±å":"éŸ³å");
  return { base, noteSol:sol, notePitch:pit, kind, src: PATHS[kind] + base + suffix + ".png" };
}

/* å»ºç›¤ */
function makeGrid(){
  const kind = state.mode; // solfege or pitch
  const bases=[...BASE_NAMES];
  const tmp=[];
  while(tmp.length<49) tmp.push(...bases);
  tmp.length=49;
  for(let i=tmp.length-1;i>0;i--){ const j=(Math.random()*(i+1))|0; [tmp[i],tmp[j]]=[tmp[j],tmp[i]]; }
  state.grid = tmp.map(b=> buildObj(b, kind));
}

/* ç•«ç›¤ */
function drawGrid(){
  gridEl.innerHTML="";
  state.grid.forEach((obj, idx)=>{
    const d=document.createElement("div"); d.className="cell"; d.dataset.idx=idx;
    const img=document.createElement("img"); img.src=obj.src; img.alt=obj.base;
    d.appendChild(img);
    d.addEventListener("click", onCellClick);
    gridEl.appendChild(d);
  });
  resetSelection();
}

/* æ‰€æœ‰åˆæ³• 4 æ ¼ç›´ç·š */
function scanSequences(){
  const res=[];
  for(let r=0;r<7;r++)for(let c=0;c<7;c++)for(const [dr,dc] of DIRS){
    const cells=[]; let ok=true;
    for(let k=0;k<4;k++){ const nr=r+dr*k, nc=c+dc*k; if(!inBounds(nr,nc)){ok=false;break;} cells.push([nr,nc]); }
    if(ok) res.push(cells);
  }
  return res;
}

/* ç™¼ä»»å‹™ï¼šå¿…å®šå­˜åœ¨æ–¼ç›¤é¢ */
function dealTask(){
  clearHintOverlay();
  const seqs=scanSequences();
  const chosen=seqs[(Math.random()*seqs.length)|0];
  const want = chosen.map(([r,c])=> state.grid[r*7+c]);
  state.task = want.map(o=> buildObj(o.base,"staff"));
  taskEl.innerHTML="";
  state.task.forEach(t=>{ const img=document.createElement("img"); img.src=t.src; img.alt=t.base; taskEl.appendChild(img); });
  state.lastAction = Date.now();
}

/* äº’å‹• */
function resetSelection(){ state.selected=[]; document.querySelectorAll(".cell").forEach(el=> el.classList.remove("selected","wrong","hinted")); clearHintOverlay(); }
function onCellClick(e){
  const el=e.currentTarget; const idx=+el.dataset.idx;
  if(state.selected.includes(idx)) return;
  state.selected.push(idx); el.classList.add("selected");
  state.lastAction = Date.now();
  if(state.selected.length===4) validateSelection();
}

/* ç›´ç·šåˆ¤æ–· */
function isStraight(sel){
  const pts = sel.map(i=> [Math.floor(i/7), i%7]);
  const [a,b,c,d]=pts, v=(p,q)=>[q[0]-p[0], q[1]-p[1]];
  const v1=v(a,b), v2=v(b,c), v3=v(c,d);
  const same=(x,y)=>x[0]==y[0]&&x[1]==y[1];
  const valid=([dr,dc])=>[-1,0,1].includes(dr)&&[-1,0,1].includes(dc)&&(dr!==0||dc!==0);
  return valid(v1)&&same(v1,v2)&&same(v2,v3);
}

/* é©—è­‰é¸æ“‡ */
function validateSelection(){
  const sel = state.selected;
  const straight = isStraight(sel);
  const cells = sel.map(i=> state.grid[i]);
  const want = state.task;
  const values = cells.map(o=> state.mode==="solfege"? o.noteSol : o.notePitch);
  const target = want.map(o=> state.mode==="solfege"? o.noteSol : o.notePitch);
  const match = straight && values.every((v,i)=> v===target[i]);

  if(match){
    mark(sel,"found");
    state.score+=10; state.done+=1; scoreEl.textContent=state.score; doneEl.textContent=state.done;
    try{ sndCorrect.currentTime=0; sndCorrect.play(); }catch{}
    resetSelection();
    if(state.done>=5){ endGame(); } else { dealTask(); }
  }else{
    mark(sel,"wrong");
    try{ sndWrong.currentTime=0; sndWrong.play(); }catch{}
    setTimeout(()=>{ mark(sel,null,true); resetSelection(); },600);
  }
}
function mark(idxs, cls, clearOnly=false){
  idxs.forEach(i=>{
    const el=gridEl.children[i];
    el.classList.remove("selected","found","wrong","hinted");
    if(!clearOnly && cls) el.classList.add(cls);
  });
}

/* å¼·åŠ›æç¤ºï¼ˆé«˜äº® + ç·šæ®µï¼‰ */
function useHintStrong(){
  if(state.hints<=0){ alert("æç¤ºæ¬¡æ•¸å·²ç”¨å®Œ"); return; }
  const seq = findCurrentTargetSeq();
  if(!seq){ alert("æ­¤ä»»å‹™æš«ä¸åœ¨ç›¤é¢ï¼Œå·²é‡æŠ½"); dealTask(); return; }
  const idxs = seq.map(([r,c])=> r*7+c);
  idxs.forEach(i=> gridEl.children[i].classList.add("hinted"));
  drawHintOverlay(idxs);
  state.lastAction = Date.now();
  state.hints--; $("#hintsLeft").textContent = state.hints;
  if(state.hints<=0) $("#hintBtn").disabled = true;
}
function findCurrentTargetSeq(){
  const target = state.task.map(o=> state.mode==="solfege"?o.noteSol:o.notePitch).join(",");
  const seqs=scanSequences();
  for(const s of seqs){
    const vals = s.map(([r,c])=> state.grid[r*7+c]).map(o=> state.mode==="solfege"?o.noteSol:o.notePitch).join(",");
    if(vals===target) return s;
  }
  return null;
}
function drawHintOverlay(idxs){
  clearHintOverlay();
  const board = document.querySelector('.board');
  const boardRect = board.getBoundingClientRect();
  const pts = idxs.map(i=>{
    const cell = gridEl.children[i];
    const r = cell.getBoundingClientRect();
    return { x: (r.left + r.width/2) - boardRect.left - 16, y: (r.top + r.height/2) - boardRect.top - 16 };
  });
  const ns="http://www.w3.org/2000/svg";
  const poly=document.createElementNS(ns,"polyline");
  poly.setAttribute("points", pts.map(p=>`${p.x},${p.y}`).join(" "));
  poly.setAttribute("fill","none");
  poly.setAttribute("stroke","#f59e0b");
  poly.setAttribute("stroke-width","6");
  poly.setAttribute("stroke-linecap","round");
  poly.setAttribute("stroke-linejoin","round");
  poly.style.filter="drop-shadow(0 0 6px rgba(245,158,11,.8))";
  hintSvg.appendChild(poly);
}
function clearHintOverlay(){ hintSvg.innerHTML=""; document.querySelectorAll(".cell.hinted").forEach(el=> el.classList.remove("hinted")); }

/* Overlay */
function openOverlay(){ overlay.style.display="flex"; }
function closeOverlay(){ overlay.style.display="none"; }

/* è¨ˆæ™‚ */
function startTimer(){
  clearInterval(state.timer); clockEl.textContent="00:00:00"; state.elapsed=0;
  state.timer=setInterval(()=>{
    if(state.paused || state.won) return;
    state.elapsed++; clockEl.textContent=formatHMS(state.elapsed);
    if(Date.now()-state.lastAction >= 30000 && !state.overlayTriggered){
      openOverlay(); state.overlayTriggered=true; // åªæç¤ºä¸€æ¬¡
    }
  },1000);
}

/* çµæŸä¸¦é¡¯ç¤ºéé—œè¦–çª— */
function endGame(){
  clearInterval(state.timer); state.won=true;
  finalTimeEl.textContent = formatHMS(state.elapsed);
  finalScoreEl.textContent = state.score;
  winOverlay.style.display="flex";
  wrapEl.classList.add("hidden");
}

/* äº‹ä»¶ */
$("#newGameBtn").addEventListener("click", startGame);
$("#shuffleBtn").addEventListener("click", ()=>{ makeGrid(); drawGrid(); dealTask(); fitGridToViewport(); });
$("#rerollBtn").addEventListener("click", dealTask);
$("#clearSelBtn").addEventListener("click", resetSelection);
$("#hintBtn").addEventListener("click", useHintStrong);
$("#pauseBtn").addEventListener("click", (e)=>{ state.paused=!state.paused; e.target.textContent= state.paused? "ç¹¼çºŒ":"æš«åœ"; });
$("#mode-sol").addEventListener("change", e=> e.target.checked && setMode("solfege"));
$("#mode-pit").addEventListener("change", e=> e.target.checked && setMode("pitch"));
overlayShowHint.addEventListener("click", ()=>{ useHintStrong(); closeOverlay(); });
overlayLater.addEventListener("click", ()=>{ state.lastAction=Date.now(); closeOverlay(); });
$("#playAgain").addEventListener("click", ()=>{ winOverlay.style.display="none"; wrapEl.classList.remove("hidden"); startGame(); });
$("#closeWin").addEventListener("click", ()=>{ winOverlay.style.display="none"; wrapEl.classList.remove("hidden"); });

function setMode(m){ state.mode=m; startGame(); }

/* åˆå§‹åŒ–èˆ‡è‡ªé©æ‡‰ */
window.addEventListener("resize", ()=>{ clearHintOverlay(); fitGridToViewport(); });

function resetSelection(){ state.selected=[]; document.querySelectorAll(".cell").forEach(el=> el.classList.remove("selected","wrong","hinted")); clearHintOverlay(); }
function onCellClick(e){
  const el=e.currentTarget; const idx=+el.dataset.idx;
  if(state.selected.includes(idx)) return;
  state.selected.push(idx); el.classList.add("selected");
  state.lastAction = Date.now();
  if(state.selected.length===4) validateSelection();
}

function startGame(){
  state.score=0; state.done=0; state.hints=MAX_HINTS; state.paused=false; state.overlayTriggered=false; state.won=false;
  scoreEl.textContent="0"; doneEl.textContent="0";
  $("#hintsLeft").textContent=MAX_HINTS; $("#hintBtn").disabled=false;
  makeGrid(); drawGrid(); dealTask(); startTimer(); fitGridToViewport();
  // å˜—è©¦æ’­æ”¾ BGMï¼ˆæœ‰äº›ç€è¦½å™¨éœ€ä½¿ç”¨è€…äº’å‹•å¾Œæ‰æœƒæ’­ï¼‰
  if(bgm.paused){ bgmToggle.textContent="æ’­æ”¾BGM"; } else { bgmToggle.textContent="æš«åœBGM"; }
}

startGame();
</script>
</body>
</html>
<footer style="text-align:center; font-size:12px; margin-top:20px;">
  "Almost New" Kevin MacLeod (incompetech.com)<br>
  Licensed under Creative Commons: By Attribution 4.0 License<br>
  <a href="http://creativecommons.org/licenses/by/4.0/" target="_blank">
    http://creativecommons.org/licenses/by/4.0/
  </a>
</footer>
